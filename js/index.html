<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>js 基础 | Study Note</title>
    <meta name="description" content="学无止境">
    <meta name="generator" content="VuePress 1.3.1">
    
    
    <link rel="preload" href="/assets/css/0.styles.26cb1efd.css" as="style"><link rel="preload" href="/assets/js/app.ed89f765.js" as="script"><link rel="preload" href="/assets/js/2.ee146c9e.js" as="script"><link rel="preload" href="/assets/js/4.46766430.js" as="script"><link rel="prefetch" href="/assets/js/10.6fe08578.js"><link rel="prefetch" href="/assets/js/11.cd75cff5.js"><link rel="prefetch" href="/assets/js/12.b67c738f.js"><link rel="prefetch" href="/assets/js/13.a7be6b36.js"><link rel="prefetch" href="/assets/js/14.0f3b09e8.js"><link rel="prefetch" href="/assets/js/15.2567e81a.js"><link rel="prefetch" href="/assets/js/16.7263d1e0.js"><link rel="prefetch" href="/assets/js/17.1fe48087.js"><link rel="prefetch" href="/assets/js/18.cb193d83.js"><link rel="prefetch" href="/assets/js/19.cf3fadcc.js"><link rel="prefetch" href="/assets/js/20.2aee8557.js"><link rel="prefetch" href="/assets/js/3.cad49ef4.js"><link rel="prefetch" href="/assets/js/5.2b008b93.js"><link rel="prefetch" href="/assets/js/6.d71a63f2.js"><link rel="prefetch" href="/assets/js/7.6919d521.js"><link rel="prefetch" href="/assets/js/8.b3808f66.js"><link rel="prefetch" href="/assets/js/9.6ebcb2ff.js">
    <link rel="stylesheet" href="/assets/css/0.styles.26cb1efd.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Study Note</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/js/" class="active sidebar-link">js 基础</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/js/#数据类型" class="sidebar-link">数据类型</a></li><li class="sidebar-sub-header"><a href="/js/#运算符优先级" class="sidebar-link">运算符优先级</a></li><li class="sidebar-sub-header"><a href="/js/#执行上下文" class="sidebar-link">执行上下文</a></li><li class="sidebar-sub-header"><a href="/js/#语句" class="sidebar-link">语句</a></li><li class="sidebar-sub-header"><a href="/js/#switch" class="sidebar-link">switch</a></li><li class="sidebar-sub-header"><a href="/js/#bind方法" class="sidebar-link">bind方法</a></li><li class="sidebar-sub-header"><a href="/js/#class" class="sidebar-link">Class</a></li><li class="sidebar-sub-header"><a href="/js/#异步编程" class="sidebar-link">异步编程</a></li><li class="sidebar-sub-header"><a href="/js/#iterator" class="sidebar-link">Iterator</a></li><li class="sidebar-sub-header"><a href="/js/#正则表达式" class="sidebar-link">正则表达式</a></li><li class="sidebar-sub-header"><a href="/js/#事件循环-event-loop" class="sidebar-link">事件循环 event loop</a></li><li class="sidebar-sub-header"><a href="/js/#ajax" class="sidebar-link">ajax</a></li><li class="sidebar-sub-header"><a href="/js/#array" class="sidebar-link">Array</a></li><li class="sidebar-sub-header"><a href="/js/#数据转换为规则" class="sidebar-link">数据转换为规则</a></li><li class="sidebar-sub-header"><a href="/js/#递归" class="sidebar-link">递归</a></li><li class="sidebar-sub-header"><a href="/js/#内存管理" class="sidebar-link">内存管理</a></li><li class="sidebar-sub-header"><a href="/js/#严格模式" class="sidebar-link">严格模式</a></li><li class="sidebar-sub-header"><a href="/js/#json-stringify" class="sidebar-link">JSON.stringify</a></li><li class="sidebar-sub-header"><a href="/js/#模块化" class="sidebar-link">模块化</a></li></ul></li><li><a href="/css/" class="sidebar-link">CSS 基础</a></li><li><a href="/css-practice/" class="sidebar-link">CSS 应用</a></li><li><a href="/dac/" class="sidebar-link">数据结构与算法</a></li><li><a href="/web/" class="sidebar-link">Web 与网络</a></li><li><a href="/git/" class="sidebar-link">git</a></li><li><a href="/linux/" class="sidebar-link">Linux</a></li><li><a href="/nginx/" class="sidebar-link">Nginx</a></li><li><a href="/node/" class="sidebar-link">node</a></li><li><a href="/react/" class="sidebar-link">React</a></li><li><a href="/vue/" class="sidebar-link">Vue</a></li><li><a href="/write/" class="sidebar-link">js 手写系列</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="js-基础"><a href="#js-基础" class="header-anchor">#</a> js 基础</h1> <h2 id="数据类型"><a href="#数据类型" class="header-anchor">#</a> 数据类型</h2> <p>5 种 基本类型，后续加入了 Symbol、BigInt</p> <h3 id="undefined"><a href="#undefined" class="header-anchor">#</a> Undefined</h3> <p><code>Undefined</code>是一种类型，<code>undefined</code>既是全局的一个变量（以前可更改，现在变成了 no-configurable、no-writable、no-enumerable，不过局部作用域如 IEFE 可重写）,也是全局变量<code>undefined</code>的值，也就是全局变量<code>window.undefined</code>的值为<code>undefined</code>。</p> <p>任何变量未赋值之前都是 Undefined 类型，且值为 undefined。而我们常用 undefined 这个全局变量来表示它，或者用 void 运算来产生一个 undefined<strong>值</strong>。</p> <blockquote><p>void 是一个运算符，对给定的表达式求值，然后返回 undefined(这里指的是值，而不是那个叫做 undefined 的全局变量)。</p></blockquote> <h3 id="null"><a href="#null" class="header-anchor">#</a> Null</h3> <p>表示这个变量未指向任何堆对象，常用于主动 GC 回收。</p> <h3 id="boolean"><a href="#boolean" class="header-anchor">#</a> Boolean</h3> <p><code>''</code>/<code>undefined</code>/<code>null</code>/<code>0</code>/<code>+0</code>/<code>-0</code>/<code>NaN</code>/<code>false</code>使用 Boolean 转换后，均为 false。</p> <h3 id="string"><a href="#string" class="header-anchor">#</a> String</h3> <p>String 类型是零个或多个 16 位无符号整数值（<code>UTF-16</code>编码方式）的所有有序序列的集合，最大长度为 2^53-1 个整数值。</p> <p>Unicode 码点范围为 U+0000~U+FFFF，共 65536 个，也叫基本字符区域（BMP）。</p> <h3 id="number"><a href="#number" class="header-anchor">#</a> Number</h3> <p>Javascript 中使用基于 IEEE754 标准的双精度浮点数来表示数字，标准规定一个数表示为<code>+-1.M * 2^e</code>，结构如下：</p> <ul><li><code>1</code> 符号位 sign bit，用来表示正负号</li> <li><code>11</code> 指数位 exponent，用来表示次方数</li> <li><code>52</code> 尾数 mantissa，用来表示精确度</li></ul> <p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAlIAAABgCAMAAADhLGzOAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAgY0hSTQAAeiYAAICEAAD6AAAAgOgAAHUwAADqYAAAOpgAABdwnLpRPAAAAAlwSFlzAAAOxAAADsQBlSsOGwAAAD9QTFRFAAAAAIAATU1NaGhofHx8gAAAjIyMmpqapv+xp6ensrKyvb29x8fH0NDQ0v3/2dnZ4eHh6enp8PDw/7Oz////tB6u6AAABP5JREFUeNrtndty6jgQRfeRfczY2IOV6f//1nmQ5As2l0pkopC1qwiNUQohrb5IEUGGUFZptsRoIJBCJSOFUC6kfC01PkSpxp0lM2l0bmB00OeQqmRetUlmrfo2INV7ubd4g5fqQ5JkvpbaqyS/SvbVBRwyIeVUD3F4ncJ9ur2Bqvaik5lZJe8TU0ukxia2bCtwyITU4CQ3rFC6jdSlMrNTeOqk8p1+1HDWYHc6OtmDRnjIVZ5fWrkno1TVmm8ks3RXuNO3Ghs5NZEvlzrauyZ0WJJCNTlOeRF9Eala/kPVVS11A6lRg6mWzNJd4U5fyxr5PtBSqU+dbHu10/tM1WQND3mQ+jhJdVrxVcNdpFqN1sSmtkCqWKePfZQzs0bN4qrc9D4X1STKk/j2JuGm0y/maUaqWKdfdLWf17BXNeOimkSZkXK9+bA+ujtDW6SKdfo5Sn3Iedvv8KKaRJmRulRS4z+HVJlO38jqUEu1qZAKYXVYhNVUTTbwcEjie8LpH0Spkpy+0+gbuc7MhR3P2OGLq2PHB9WhmhzVwUMupHb3lW45/X4tVarTez39d6VBHh6OQGpsHjj9LlLlOn31dC869hDyI/U4Uv08px+f3nGt2DzPidRqXwmnR19HarWvhNOjHIlvtWJDKANSx5xpGdnrIUrlRYqg92trqeFRLXWSOjOv2qyWN2lwtZlZ59TZ4mhxaJceP6r2v3El2MD7oUit9pX22rXqB53NzurPOs8V/Vl9Hx6Ho8WpXXpc7KyB06FIPSEnM1VmVjlXLXJlFa+nAOeuHn/rzEmDc+ezc0M4MVhd1uEznkhvfPxER2qDciD1aOqV/kLWp8R26xbaFYJU/yGdvSqz+mIxbM7hczqIE4/jpDboFUi59Lw7Ne7jfpS6XkR+a3KbOjF29Y4PhIM48ThOaoNegVSr3qsy6zSOoZIPFf1cS1k6auwLSnzzbdDJ7yAVDuLE4zipDXoFUtaGakONWaPRpCGcNOicWybC2G4xk3UZSN26hYM483EckHoZUj9xwbREx8n3O0iFgzjxOE5qg0DqmcTnXLdOhLVJ8bMc8RMdqQ0CKfQGSCEEUuhbkPpzuOwvejfdR+pohP/YX/z4zQRS6HiklJASSKE8SM3bNSCFsiS+cM5DIvGhXLXUdHQFpFCm8jwd6AUpxIoPFYrUNOMghbIihdBXBVLoCKSE0FcEUuh4pP6N0j9RBxr/RWG8jwFSGCCFAVIgBVIghQFSGCAFUiAFUhgghQFSGCAFUhgghQFSGCAFUiAFUhgghQFSIAVSIIUBUhggxRyAFEhhgBQGSGGAFEhhgBTGS5FCiA+wo6KRQij/PwOaSTvuqz/Et4u8Hz+6hdQcvTZxLOOrSwe/BHo5UdupBCl0DFIkPpQ58W3Ym34i9Lny/Pqapm+XyRMbN3zGkKkCR0Sbobm/SsbznkIq32BppnT7IuUFQj1+/zKYejCC12luUavnZFY7RBlIvWF5vk1zWsaWfC+qvcsqjyhT+iq5ZdfjRVMcqylt6xczpf06YOuT2QfqBjwqFSmlYKVlLJ8uajlEMpDaIKXJ/dZTrcyu/3OQsj2k9u5A6maU0jozpTWalG2OdHvqfiRS68QNUo+Qyl3B7fFZdC31VJQyotRdpH5zkUniy4wUe+Xb8lyaa3K7gmg5XKz4jJ3f50bpBb8DUiAFUvuFMhu/qESnROiO/gelYw4zOa/M4QAAAABJRU5ErkJggg==" alt=""></p> <blockquote><p>0.1 + 0.2 运算不标准的原因就在于有的数（比如 0.1）用该方法表达时是无穷的，必须进行截断，所以不精确。而此运算，有 2 次的摄入，造成了精度丢失很大。比较大小正确的方式是检查等式左右两边差的绝对值是否小于最小精度：
<code>Math.abs(0.1 + 0.2 - 0.3) &lt;= Number.EPSILON</code></p></blockquote> <p>最大最小值分别为：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>Number<span class="token punctuation">.</span><span class="token constant">MIN_SAFE_INTEGER</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">**</span> <span class="token number">53</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Number<span class="token punctuation">.</span><span class="token constant">MAX_SAFE_INTEGER</span> <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">**</span> <span class="token number">53</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="window-isnan-与-number-isnan"><a href="#window-isnan-与-number-isnan" class="header-anchor">#</a> window.isNaN 与 Number.isNaN</h4> <p>Number 是新来的，判断更贴合字面意思，就是判断此值是不是 NaN。而 window.isNaN 在判断前会进行数字转换一次，看此值到底能不能当成数字使用。</p> <h3 id="symbol"><a href="#symbol" class="header-anchor">#</a> Symbol</h3> <p>表示一个独一无二的值，直接使用不带 new 的构造函数生成。</p> <h3 id="object"><a href="#object" class="header-anchor">#</a> Object</h3> <h4 id="属性种类"><a href="#属性种类" class="header-anchor">#</a> 属性种类</h4> <ul><li>accessor properties 访问器属性，get/set 方法</li> <li>data properties 数据属性</li> <li>internal properties 内部属性，不可见且无名，例如：[[Prototype]]、[[Extensible]]、[[DefineOwnProperty]]、[[Put]]（赋值运算符=所调用的方法）</li></ul> <h4 id="object-defineproperty"><a href="#object-defineproperty" class="header-anchor">#</a> <code>Object.defineProperty</code></h4> <p>定义对象 o 的属性 p，并返回对象 o。</p> <h5 id="内容"><a href="#内容" class="header-anchor">#</a> 内容</h5> <p>其中 descriptor 分为如下：</p> <ul><li>公共描述符
<ul><li><code>configurable</code>(false)能否配置以及被删除（具体影响见下文）</li> <li><code>enumerable</code>(false) 能否枚举</li></ul></li> <li>择其一
<ul><li>data scriptors
<ul><li><code>value</code>(undefined)</li> <li><code>writable</code>(false) 该值是否能够被更改（只设置此值只能限制赋值运算符更改，想完全限制需要结合 configurable 属性）</li></ul></li> <li>accessor descriptors
<ul><li><code>get</code>(undefined)</li> <li><code>set</code>(undefined)</li></ul></li></ul></li></ul> <h5 id="configurable详解"><a href="#configurable详解" class="header-anchor">#</a> <code>configurable</code>详解</h5> <p>配置为 false 时，即：</p> <ol><li>不能删除属性 p</li> <li>不能重新配置属性 p，但有例外：
<ol><li>writable 为 true 时，配置 value</li> <li>writable 为 true 时，配置 writable</li></ol></li> <li>不能数据描述符与访问器描述符之间互转</li></ol> <blockquote><p>所谓不能重新配置，并不是不能再次调用，只要这次调用的参数值与 configurable 为 false 时设置的一样，依然可以调用。实际上就是一个徒劳的举动。</p></blockquote> <p>2.2 的来历：</p> <blockquote><p>There is one exception to this rule—JavaScript allows you to change an unconfigurable property from writable to read-only, for historic reasons; the property length of arrays has always been writable and unconfigurable. Without this exception, you wouldn’t be able to freeze (see Freezing) arrays.</p></blockquote> <h5 id="与赋值运算符-的区别"><a href="#与赋值运算符-的区别" class="header-anchor">#</a> 与赋值运算符=的区别</h5> <p>区别：</p> <ol><li>原对象 o 有属性 p。赋值运算符会被访问器属性中的 setter 和数据属性中的 writable:false 控制，就此结束。而定义是根据一定的规则重新配置原属性。</li> <li>原对象 o 的原型有属性 p。如果将要操作的属性 p 是来自于原型，那么赋值会被 setter 和 writable 影响，而定义不会（就算原型的 p 属性被设置为 configurable:false, writable:false 也不会）。</li> <li>原对象 o 无属性 p。执行新增操作，赋值运算符虽然是调用[[Put]]进行操作，但是最后两者都会殊途同归调用[[DefineOwnProperty]]，区别在于默认值的设置。前者全为 true，后者全为 false。</li></ol> <p>共同：</p> <ol><li>创建新的值时都会检测对象 o 是否是非扩展对象。
<blockquote><p>扩展对象，检查用 Object.isExtensible()，设置用 Object.preventExtensions()，注意与冻结的区别。</p></blockquote></li></ol> <h4 id="object-is"><a href="#object-is" class="header-anchor">#</a> <code>Object.is</code></h4> <p>与<code>===</code>区别：</p> <ul><li><code>+0</code> 与 <code>-0</code>，<code>===</code>返回 true，Object.is 返回 false</li> <li><code>NaN</code>与<code>NaN</code>，<code>===</code>返回 false，Object.is 返回 true</li></ul> <h4 id="对象遍历"><a href="#对象遍历" class="header-anchor">#</a> 对象遍历</h4> <h5 id="for-in"><a href="#for-in" class="header-anchor">#</a> for in</h5> <p>含原型的可枚举属性。</p> <h5 id="reflect-ownkeys"><a href="#reflect-ownkeys" class="header-anchor">#</a> Reflect.ownKeys()</h5> <p>自身的可枚举、不可枚举、symbol 属性。</p> <h5 id="object-keys"><a href="#object-keys" class="header-anchor">#</a> Object.keys()</h5> <p>自身的可枚举属性。</p> <h5 id="object-getownpropertynames"><a href="#object-getownpropertynames" class="header-anchor">#</a> Object.getOwnPropertyNames()</h5> <p>自身的可枚举与不可枚举属性。</p> <h5 id="object-getownpropertysymbols"><a href="#object-getownpropertysymbols" class="header-anchor">#</a> Object.getOwnPropertySymbols()</h5> <p>自身的 symbol 属性。</p> <h5 id="object-values-与-object-entries"><a href="#object-values-与-object-entries" class="header-anchor">#</a> Object.values()与 Object.entries()</h5> <p>与 Object.keys()成对，所以一样，自身的可枚举属性的属性值。</p> <ul><li>首先遍历所有数值键，按照数值升序排列。</li> <li>其次遍历所有字符串键，按照加入时间升序排列。</li> <li>最后遍历所有 Symbol 键，按照加入时间升序排列。</li></ul> <h3 id="类型转换"><a href="#类型转换" class="header-anchor">#</a> 类型转换</h3> <p>基本类型中只有 Number、String、Boolean、Symbol 存在构造函数，
有几条规则注意：</p> <ul><li>Number -&gt; Boolean，0/+0/-0/NaN 为 false，其余为 true 包括+Infinity/-Infinity。</li> <li>String -&gt; Boolean, 只有''为 false。</li> <li>Symbol -&gt; Number/String，报错</li> <li>Object -&gt; Number/String，拆箱转换，调用 valueOf、toString 方法，遇到基本类型就停止，最后无基本类型就报错，有了基本类型再转换位 Number/String。
<blockquote><p>转成数字时顺序为 valueOf 再 toString，转成字符串时相反。注意，<code>n + ''</code>与<code>n + 1</code>都是属于转数字优先，调用顺序为 valueOf 再 toString。</p></blockquote></li></ul> <h3 id="类型判断"><a href="#类型判断" class="header-anchor">#</a> 类型判断</h3> <ul><li>typeof 操作符： 简单判断类型，无法区分例如数组与对象、null 与对象。</li> <li>instanceof 操作符/isPrototypeOf()： 测试实例与原型链中<strong>出现过</strong>的构造函数。
<blockquote><p>当构造函数返回的是引用类型时，无法判断。</p></blockquote></li> <li>Object.prototype.toString.call(obj)。这个方法返回该值的 class 类，即<code>[[class]]</code>私有属性。在早期，由于该属性是不能更改的，所以这样判断很安全。但是，es6 后该属性被<code>Symbol.toStringTag</code>所代替，变得可以被更改，如下：</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>toStringTag<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&quot;HelloKitty&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &quot;[object HelloKitty]&quot;</span>
</code></pre></div><blockquote><p>当变量为装箱类型时，需要再加上 typeof 判断是否是基本类型。</p></blockquote> <ul><li>obj.hasOwnProperty(key) 判断 obj 实例有没有 key 属性</li></ul> <h3 id="map"><a href="#map" class="header-anchor">#</a> Map</h3> <p>保存键值对。</p> <ul><li>能够记住键的原始插入顺序</li> <li>任何值都可以作为键值</li> <li>是iterable的，可以直接被迭代</li> <li>在频繁增删键值对的场景下表现更好</li></ul> <h2 id="运算符优先级"><a href="#运算符优先级" class="header-anchor">#</a> 运算符优先级</h2> <p>这里只列出易混顺序</p> <ul><li>成员访问类：
<ul><li><code>.</code>访问</li> <li><code>[]</code>访问</li> <li><code>new F()</code><strong>new运算带参数列表</strong></li> <li><code>F()</code>函数调用</li> <li><code>?.</code> 可选链</li></ul></li> <li><code>new F</code><strong>new运算无参数列表</strong></li> <li><code>&amp;&amp;</code></li> <li><code>||</code></li> <li>三元运算符<code>? :</code></li> <li>赋值类运算符<code>=</code></li></ul> <h2 id="执行上下文"><a href="#执行上下文" class="header-anchor">#</a> 执行上下文</h2> <p>执行上下文在 ES3 中，包含三个部分。</p> <ul><li>scope：作用域，也常常被叫做作用域链。</li> <li>variable object：变量对象，用于存储变量的对象。</li> <li>this value：this 值。</li></ul> <p>在 ES5 中，我们改进了命名方式，把执行上下文最初的三个部分改为下面这个样子。</p> <ul><li>lexical environment：词法环境，当获取变量时使用。</li> <li>variable environment：变量环境，当声明变量时使用。</li> <li>this value：this 值。</li></ul> <p>在 ES2018 中，执行上下文又变成了这个样子，this 值被归入 lexical environment，但是增加了不少内容。</p> <ul><li>lexical environment：词法环境，当获取变量或者 this 值时使用。</li> <li>variable environment：变量环境，当声明变量时使用。</li> <li>code evaluation state：用于恢复代码执行位置。</li> <li>Function：执行的任务是函数时使用，表示正在被执行的函数。</li> <li>ScriptOrModule：执行的任务是脚本或者模块时使用，表示正在被执行的代码。</li> <li>Realm：使用的基础库和内置对象实例。</li> <li>Generator：仅生成器上下文有这个属性，表示当前生成器。</li></ul> <blockquote><p>Realm 即领域，国度的意思。例如两个不同 iframe 属于不同的 realm，此时一些对象并不是共用的。</p></blockquote> <div class="language-javascaript extra-class"><pre class="language-text"><code>var iframe = document.createElement('iframe')
document.documentElement.appendChild(iframe)
iframe.src=&quot;javascript:var b = {};&quot;
var b1 = iframe.contentWindow.b;
var b2 = {};
console.log(typeof b1, typeof b2); //undefined object
console.log(b1 instanceof Object, b2 instanceof Object); //false true
</code></pre></div><h3 id="作用域"><a href="#作用域" class="header-anchor">#</a> 作用域</h3> <p>es6 中，很多块中都会使 let 和 const 变量产生作用域。</p> <p>var 声明的作用域是最近的函数体，所以会产生变量穿透，甚至产生变量声明的和赋值的不是同一个变量的奇怪现象，例如：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> b<span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> env <span class="token operator">=</span> <span class="token punctuation">{</span> b<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;In function b:&quot;</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
  <span class="token keyword">with</span> <span class="token punctuation">(</span>env<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;In with b:&quot;</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Global b:&quot;</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// undefined</span>
</code></pre></div><p>&quot;具有名称的函数表达式&quot;会在外层词法环境和它自己执行产生的词法环境之间产生一个词法环境，再把自己的名称和值当作变量塞进去。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  b <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [Function: b]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>所以这里的 b = 20 并没有改变外面的 b，而是试图改变一个只读的变量 b。</p> <h3 id="闭包"><a href="#闭包" class="header-anchor">#</a> 闭包</h3> <p>闭包是一个绑定了执行环境的函数</p> <h3 id="this"><a href="#this" class="header-anchor">#</a> this</h3> <p>获取函数的表达式，它实际上返回的并非函数本身，而是一个 Reference 类型，它由一个对象和一个属性值构成。</p> <h3 id="变量对象"><a href="#变量对象" class="header-anchor">#</a> 变量对象</h3> <p>跟执行上下文相关的一个隐式对象。包含：</p> <ul><li>变量声明（VariableDeclaration）</li> <li>函数声明（FunctionDeclaration）</li> <li>形参</li></ul> <h4 id="全局对象"><a href="#全局对象" class="header-anchor">#</a> 全局对象</h4> <p>VO === this === global</p> <p>在浏览器中，全局对象的 window 属性指向了全局对象，而不是 window 就是全局对象，如下:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>global <span class="token operator">=</span> <span class="token punctuation">{</span>
  Math<span class="token operator">:</span> <span class="token operator">&lt;</span><span class="token operator">...</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  String<span class="token operator">:</span> <span class="token operator">&lt;</span><span class="token operator">...</span><span class="token operator">&gt;</span>
  <span class="token operator">...</span>
  <span class="token operator">...</span>
  window<span class="token operator">:</span> global
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>在全局上，变量声明与未声明的区别在于，声明的变量不能被 delete 删除（eval 中定义的可以删除），而因为未声明被挂载到 global 的变量可以删除。</p></blockquote> <h4 id="函数上下文中的变量对象"><a href="#函数上下文中的变量对象" class="header-anchor">#</a> 函数上下文中的变量对象</h4> <p>VO === AO</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token constant">AO</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  arguments<span class="token operator">:</span> <span class="token punctuation">{</span>
    callee<span class="token operator">:</span> 当前函数的引用<span class="token punctuation">,</span>
    length<span class="token operator">:</span> 实参的个数，
    properties<span class="token operator">-</span>indexes：
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>arguments 对象的 properties-indexes 的值与当前（实际传递的）形参是共享的，修改一个，另一个跟着变，但是未传入的参数不共享。例如函数形参 3 个，实参 2 个，那么 arguments[2]与 z 各是个的值，而 arguments[0]与 x 则共享。</p> <h4 id="处理上下文代码的-2-个阶段"><a href="#处理上下文代码的-2-个阶段" class="header-anchor">#</a> 处理上下文代码的 2 个阶段</h4> <ol><li>进入执行上下文。依代码顺序在变量对象上填充属性，对于函数声明，直接增加 key 赋值 value，并且重名替换。对于形参与变量声明，增加 key 赋值 undefined，但是重名忽略。</li> <li>执行代码</li></ol> <h2 id="语句"><a href="#语句" class="header-anchor">#</a> 语句</h2> <h3 id="普通语句"><a href="#普通语句" class="header-anchor">#</a> 普通语句</h3> <ul><li>声明类语句（var/const/let/function/class）</li> <li>表达式语句</li> <li>空语句</li> <li>with 语句</li> <li>debugger 语句</li></ul> <h3 id="语句块"><a href="#语句块" class="header-anchor">#</a> 语句块</h3> <h3 id="控制型语句"><a href="#控制型语句" class="header-anchor">#</a> 控制型语句</h3> <p>if/switch/for/while/continue/break/return/throw/try</p> <p>在各种控制语句组合中，有如下情况：</p> <ul><li>产生“消费的”：
<ul><li>switch + break</li> <li>for/while + break</li> <li>for/while + continue</li> <li>function + return</li> <li>try + throw</li></ul></li> <li>产生报错的
<ul><li>function + break</li> <li>function + continue</li></ul></li> <li>特殊处理的，try/catch/finally + break/continue/return
<blockquote><p>这里的特殊处理指的是，try/catch 的非 normal 型完成记录并不会立即返回，而是还要加上 finally 的完成记录一起判断。</p></blockquote></li> <li>其余均穿透</li></ul> <h3 id="带标签的语句"><a href="#带标签的语句" class="header-anchor">#</a> 带标签的语句</h3> <p>形如<code>hello: var a = 3</code>，冒号前面的字符串用于设定“完成记录类型 Completion Record”的[[target]]字段，主要用于以指定方式跳出多重循环。</p> <p>例如<code>break hello</code>会产生带有[[target]]为 hello 的完成记录，那么只有带有 hello 的标签才能“消费”它。</p> <h2 id="switch"><a href="#switch" class="header-anchor">#</a> switch</h2> <ul><li>用全等比对 switch 传入的表达式值与 case 后面的表达式值，true 就执行 case 下面的代码，false 则找寻 default 代码。</li> <li>一旦代码开始执行（包括 case 的代码或者 default 的代码），如果没有碰到 break，不管后面的 case 条件，一律直接执行。</li></ul> <h2 id="bind方法"><a href="#bind方法" class="header-anchor">#</a> <code>bind</code>方法</h2> <ul><li>bind 会产生一个<strong>新方法</strong>，方法名为<code>bound 原函数名</code></li> <li><code>bind</code>传递的参数优先级比原函数高，且后来的参数是紧跟着<code>bind</code>参数的后面，而不是对位取代</li> <li>bind 返回的函数可以通过 new 调用，这时提供的 this 的参数被忽略，指向了 new 生成的全新对象。内部模拟实现了 new 操作符</li></ul> <h3 id="手写-bind"><a href="#手写-bind" class="header-anchor">#</a> 手写 bind</h3> <ol><li>返回<code>bound</code>方法</li> <li>通过<code>this instanceof bound</code>来决定是否模拟 new 操作符</li> <li>调整返回方法的<code>name</code>与参数的<code>length</code></li></ol> <h2 id="class"><a href="#class" class="header-anchor">#</a> Class</h2> <h3 id="定义"><a href="#定义" class="header-anchor">#</a> 定义</h3> <p>class 为构造函数的语法糖。</p> <p>在 react 中经常会用到=符号设置属性，转化为 es5 的过程稍有区别，=符号设置的实例属性是直接挂载在生成的实例属性上，而构造函数里的属性则是挂载在类的 prototype 对象上。类的属性设置区别不大。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">Cat</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function-variable function">fn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'from &quot;=&quot; setting'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function-variable function">fn2</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  name <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>

  <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'from &quot;()&quot; setting'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> s <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token function">sfn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'from &quot;()&quot; setting'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">static</span> <span class="token function-variable function">sfn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'from &quot;=&quot; setting'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>转化后</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">_defineProperty</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      value<span class="token operator">:</span> value<span class="token punctuation">,</span>
      enumerable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      configurable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      writable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> Cat <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">Cat</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

    <span class="token function">_defineProperty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">&quot;fn&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'from &quot;=&quot; setting'</span><span class="token punctuation">,</span> _this<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">_defineProperty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">&quot;fn2&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">_defineProperty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">var</span> _proto <span class="token operator">=</span> <span class="token class-name">Cat</span><span class="token punctuation">.</span>prototype<span class="token punctuation">;</span>

  _proto<span class="token punctuation">.</span><span class="token function-variable function">fn</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'from &quot;()&quot; setting'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  Cat<span class="token punctuation">.</span><span class="token function-variable function">sfn</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">sfn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'from &quot;()&quot; setting'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> Cat<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">_defineProperty</span><span class="token punctuation">(</span>Cat<span class="token punctuation">,</span> <span class="token string">&quot;s&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">_defineProperty</span><span class="token punctuation">(</span>Cat<span class="token punctuation">,</span> <span class="token string">&quot;sfn&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'from &quot;=&quot; setting'</span><span class="token punctuation">,</span> Cat<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="继承"><a href="#继承" class="header-anchor">#</a> 继承</h3> <p>最好的继承的特点：</p> <ul><li>能给超类构造函数传参</li> <li>拥有共享方法</li> <li>constructor 能正确指向</li></ul> <h4 id="原型链继承"><a href="#原型链继承" class="header-anchor">#</a> 原型链继承</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">SubType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token class-name">SubType</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SuperType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="借用构造函数继承（constructor-stealing）"><a href="#借用构造函数继承（constructor-stealing）" class="header-anchor">#</a> 借用构造函数继承（constructor stealing）</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">SubType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">SuperType</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="组合继承（conbination-inheritance）"><a href="#组合继承（conbination-inheritance）" class="header-anchor">#</a> 组合继承（conbination inheritance）</h4> <p>结合原型链继承与借用构造函数继承。</p> <h4 id="原型式继承（prototypal-inheritance）"><a href="#原型式继承（prototypal-inheritance）" class="header-anchor">#</a> 原型式继承（prototypal inheritance）</h4> <p>即 es5 的 Object.create()方法。需要一个基础对象，来创建另一个类似的对象。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">object</span><span class="token punctuation">(</span><span class="token parameter">o</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">function</span> <span class="token constant">F</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token class-name">F</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> o<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">F</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="寄生式继承（parasitic-inheritance）"><a href="#寄生式继承（parasitic-inheritance）" class="header-anchor">#</a> 寄生式继承（parasitic inheritance）</h4> <p>创建一个仅用于封装继承过程的函数，该函数在内部以某种方式来增强对象。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">createAnother</span><span class="token punctuation">(</span><span class="token parameter">original</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> clone <span class="token operator">=</span> <span class="token function">object</span><span class="token punctuation">(</span>original<span class="token punctuation">)</span><span class="token punctuation">;</span>
  clone<span class="token punctuation">.</span><span class="token function-variable function">sayHi</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;hi&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> clone<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="寄生组合式继承"><a href="#寄生组合式继承" class="header-anchor">#</a> 寄生组合式继承</h4> <p>通过借用构造函数来继承属性，使用寄生式继承来继承超类的原型。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token class-name">SubType</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token function">object</span><span class="token punctuation">(</span><span class="token class-name">SuperType</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">SubType</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor <span class="token operator">=</span> SubType<span class="token punctuation">;</span>
</code></pre></div><blockquote><p>类的静态属性继承：<code>Object.setPrototypeOf(SubType, SuperType)</code></p></blockquote> <h3 id="原型"><a href="#原型" class="header-anchor">#</a> 原型</h3> <p>原型，即[[prototype]]。目前最新的操作原型的方式如下，在早期我们只能使用 new 来操作原型（<strong>_proto</strong>并不标准）：</p> <ul><li>Object.create，根据指定对象为原型创建新的对象。</li> <li>Object.getPrototypeOf，获取原型</li> <li>Object.setPrototypeOf，设置原型</li></ul> <p>要产生一个变量 v，需要：</p> <ol><li>能设置 v 的自有属性（要是能按一定逻辑设置就更好了）</li> <li>能设置 v 的公有属性</li></ol> <p>js 用了以下东西来操作：</p> <ol><li>用一个函数 f 来设置自有属性，函数拥有逻辑，更贴切</li> <li>一个对象 p，包含所有类 v 变量的公有属性</li></ol> <p>为了更加紧密、规范：</p> <ol><li>函数采用大写命名 F，别名构造函数</li> <li>函数天生拥有一个属性<code>prototype</code>，来存储对象 p</li></ol> <p>所以任何一个变量 v 就可以由一个构造函数 F 生成。</p> <p>生成后的 v 怎么与构造函数关联呢。</p> <p>想当然的是 v 的一个属性指向构造函数 F，问题有两：</p> <ul><li>该关联属性应该有所隐藏，不能算作 v 表现的东西</li> <li>找寻公有属性，需要多取一次值，需要 F.prototype，一次到没什么，当层级多了以后，这是一种不必要的浪费</li></ul> <p>js 采用了以下设置：</p> <ol><li>变量 v 拥有一个隐式原型<code>__proto__</code></li> <li><code>__proto__</code>直接指向公有属性 p，而不是构造函数 F，而出于又要能与构造函数 F 关联，所以把 F 存在了公有属性 p 的属性<code>constructor</code>中</li></ol> <p>至此，一切关联都理所当然。</p> <h4 id="解决-function"><a href="#解决-function" class="header-anchor">#</a> 解决 Function</h4> <p>构造函数 F 又是谁生成的呢？按照推论到底，是 Function 函数，那么 Function 函数又是由哪个构造函数生成的呢。</p> <p>函数 Function 自己创造了自己，这条规则却不适用于 Object.prototype</p> <ul><li>✅<code>Function.__proto__.constructor === Function</code></li> <li>✅<code>Function.__proto__ === Function.prototype</code></li> <li>❌<code>Object.prototype.__proto__ === Object.prototype</code></li></ul> <h4 id="解决-object-prorotype"><a href="#解决-object-prorotype" class="header-anchor">#</a> 解决 Object.prorotype</h4> <p>公有属性 p，也就是原型 prototype 推论到底，是由 Object 构造函数生成的，Object 在上述第一个问题中产生，可是 Object.prototype 又是怎么产生的。</p> <p>null 不借构造函数就创造了 Object.prototype，即：</p> <ul><li>✅<code>Object.prototype.__proto__ === null</code></li></ul> <p>那么自然 Object.prototype 的构造函数也没有。</p> <p><img src="/assets/img/prototype.f34c4d55.jpg" alt="http://www.mollypages.org/tutorials/js.mp"></p> <h3 id="new"><a href="#new" class="header-anchor">#</a> new</h3> <ol><li>创建空对象</li> <li>链接原型链</li> <li>执行构造函数</li> <li>根据步骤 3 的结果类型返回不同的值</li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> <span class="token function-variable function">_new</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> Constructor <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> Constructor <span class="token operator">!==</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;请传入正确的构造函数&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">var</span> instance <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Constructor</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> ret <span class="token operator">=</span> <span class="token function">Constructor</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> ret <span class="token keyword">instanceof</span> <span class="token class-name">Object</span> <span class="token operator">?</span> ret <span class="token operator">:</span> instance<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="异步编程"><a href="#异步编程" class="header-anchor">#</a> 异步编程</h2> <h3 id="promise"><a href="#promise" class="header-anchor">#</a> Promise</h3> <p>promise 的 then，如果在执行 promise 后，该 promise 为 resolved 状态，那么 then 会被马上进入微任务队列。</p> <h4 id="promise-resolve"><a href="#promise-resolve" class="header-anchor">#</a> Promise.resolve()</h4> <p>灵活运用转 Promise 对象的接口 Promise.resolve()。</p> <p>参数处理情况如下：</p> <ul><li>Promise 对象，直接返回。</li> <li>thenable 对象，该对象 then 方法里必须使用 resolve 或者 reject，否则 Promise.resolve(thenable 对象)一直是 pending 状态</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">then</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 等价于</span>
<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>then<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>其他值。</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 等价于</span>
<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>不传值。等价于 Promise(undefined)</li></ul> <h4 id="利用runner函数进行带逻辑的异步请求"><a href="#利用runner函数进行带逻辑的异步请求" class="header-anchor">#</a> 利用<code>runner</code>函数进行带逻辑的异步请求</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">runner</span><span class="token punctuation">(</span><span class="token parameter">_gen</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> gen <span class="token operator">=</span> <span class="token function">_gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">_next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">_next</span><span class="token punctuation">(</span><span class="token parameter">_last_res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> res <span class="token operator">=</span> gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>_last_res<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> obj <span class="token operator">=</span> res<span class="token punctuation">.</span>value<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>obj<span class="token punctuation">.</span>then<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          obj<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
            <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              <span class="token function">_next</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> obj <span class="token operator">==</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>
            obj<span class="token punctuation">.</span>constructor
              <span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;function GeneratorFunction()&quot;</span><span class="token punctuation">)</span>
          <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">runner</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">_next</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">_next</span><span class="token punctuation">(</span><span class="token function">obj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token function">_next</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">runner</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> userData <span class="token operator">=</span> <span class="token keyword">yield</span> $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span> url<span class="token operator">:</span> <span class="token string">&quot;getUserData&quot;</span><span class="token punctuation">,</span> dataType<span class="token operator">:</span> <span class="token string">&quot;json&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>userData<span class="token punctuation">.</span>type <span class="token operator">==</span> <span class="token string">&quot;VIP&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> items <span class="token operator">=</span> <span class="token keyword">yield</span> $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span> url<span class="token operator">:</span> <span class="token string">&quot;getVIPItems&quot;</span><span class="token punctuation">,</span> dataType<span class="token operator">:</span> <span class="token string">&quot;json&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> items <span class="token operator">=</span> <span class="token keyword">yield</span> $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span> url<span class="token operator">:</span> <span class="token string">&quot;getItems&quot;</span><span class="token punctuation">,</span> dataType<span class="token operator">:</span> <span class="token string">&quot;json&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">//生成、...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>与<code>async/await</code>区别</p> <ul><li>写法一样，还不需要<code>runner</code>函数</li> <li>还可以写成箭头函数。</li></ul></blockquote> <h3 id="generator-函数"><a href="#generator-函数" class="header-anchor">#</a> Generator 函数</h3> <ul><li>一个状态机，内部封装了很多种状态。</li> <li>此函数会返回一个遍历器对象</li></ul> <p>可用结构操作符<code>...</code>遍历。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">initializer</span><span class="token punctuation">(</span>count<span class="token punctuation">,</span> <span class="token function-variable function">mapFunc</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token function">mapFunc</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mapFunc<span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">&quot;GeneratorFunction&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">yield</span><span class="token operator">*</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">yield</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 用于生成52张扑克牌</span>
<span class="token keyword">const</span> cards <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token operator">...</span><span class="token function">initializer</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> p <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      p <span class="token operator">=</span> <span class="token string">&quot;A&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">===</span> <span class="token number">11</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      p <span class="token operator">=</span> <span class="token string">&quot;J&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">===</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      p <span class="token operator">=</span> <span class="token string">&quot;Q&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">===</span> <span class="token number">13</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      p <span class="token operator">=</span> <span class="token string">&quot;K&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">yield</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">♠</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>p<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">yield</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">♣️</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>p<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">yield</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">♥️</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>p<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">yield</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">♦️</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>p<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="async-await"><a href="#async-await" class="header-anchor">#</a> async/await</h3> <div class="language-javascaript extra-class"><pre class="language-text"><code>// 注意区分
const a = yield 3; // a: undefined
const b = await 3; // b: 3
</code></pre></div><h2 id="iterator"><a href="#iterator" class="header-anchor">#</a> <code>Iterator</code></h2> <p>默认的 Iterator 接口部署在数据结构的 Symbol.iterator 属性上。换言之，只要一个数据实现了这个属性，他就可以使用 for...of 进行遍历。此属性值必须为一个<strong>遍历器对象</strong>（含有 next 方法的对象）。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token punctuation">{</span>
            value<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
            done<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token punctuation">{</span>
            value<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
            done<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> k <span class="token keyword">of</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 3</span>
</code></pre></div><h2 id="正则表达式"><a href="#正则表达式" class="header-anchor">#</a> 正则表达式</h2> <p>正则要么匹配字符，要么匹配位置。</p> <h3 id="提示要点"><a href="#提示要点" class="header-anchor">#</a> 提示要点</h3> <ul><li>字符集<code>[]</code>中的特殊字符无需转义符<code>\</code>（转义也可以）</li> <li><code>\1</code> <code>\2</code>代表括号匹配结果，宿主环境不一定是这个，例如 js 环境中是<code>$1</code></li></ul> <h3 id="位置"><a href="#位置" class="header-anchor">#</a> 位置</h3> <p><code>\b</code> <code>\B</code> <code>^</code> <code>$</code> <code>(?=p)</code> 都表示位置，位置都不参与实际匹配结果。</p> <h4 id="p-："><a href="#p-：" class="header-anchor">#</a> <code>(?=p)</code>：</h4> <p>表示 p 前面的位置。反义是<code>(?!p)</code>。反向是<code>(?&lt;=p)</code>，表示 p 后面的位置。反义是<code>(?&lt;!p)</code>。</p> <p>p 本身并不是匹配结果，它只是匹配的条件。例如你要匹配的字符是 xxx。只能使用如下几种组合方式：
<code>xxx(?=p)</code> positive lookahead
<code>xxx(?!p)</code> negative lookahead
<code>(?&lt;=p)xxx</code> positive lookbehind
<code>(?&lt;!p)xxx</code> negative lookbehind</p> <h3 id="贪婪模式"><a href="#贪婪模式" class="header-anchor">#</a> 贪婪模式</h3> <p>默认匹配是贪婪匹配，可以在量词<code>*</code>或者<code>{m,n}</code>后面加上<code>?</code>符号，使其惰性匹配。</p> <h3 id="分组"><a href="#分组" class="header-anchor">#</a> 分组</h3> <p>匹配下面一个字符</p> <ul><li>在代码里是字符串模式</li> <li>里面有双斜杠<code>//</code></li></ul> <p>那么规则为</p> <div class="language- extra-class"><pre class="language-text"><code>/(?&lt;!\\)('|&quot;|`).*?\/\/.*?(?&lt;!\\)\1/mg
</code></pre></div><h3 id="计算匹配结果"><a href="#计算匹配结果" class="header-anchor">#</a> 计算匹配结果</h3> <ul><li><code>match</code>字符串的方法，在没g的情况下跟exec类似，但是正则表达式带g，那么就只返回匹配结果的数组，<strong>不含括号捕获值</strong></li> <li><code>exec</code>正则表达式的方法，返回数组，<strong>只返回第一次的匹配，后续为括号捕获值</strong></li> <li><code>test</code>返回Boolean值</li></ul> <h2 id="事件循环-event-loop"><a href="#事件循环-event-loop" class="header-anchor">#</a> 事件循环 event loop</h2> <ul><li>主进程（即整体代码）属于<code>macrotasks</code>（<code>tasks</code>）。待执行完毕才会去寻找<code>microtask</code> (主动使用<code>.click()</code>触发事件，不属于异步！此时并没结束主进程，所以如果有事件冒泡，这时会先冒完，而且此时<code>MutationObserver</code>处于<code>pending</code>状态，无法多次实现)</li> <li><code>js</code>通过事件循环（<code>event loop</code>）机制来定期访问异步任务队列</li> <li><code>macroTasks</code>的任务，一次循环只处理一次（比如嵌套<code>setTimeout</code>)，而<code>microtask</code>队列能处理多次（比如<code>Promise</code>的<code>then</code>回调）</li></ul> <p><strong>宏任务 macro-task</strong>（由宿主发起）</p> <ul><li><code>setTimeout</code></li> <li><code>setInterval</code></li> <li><code>I/O</code></li> <li><code>setImmediate</code> (<code>node</code>, 在<code>v.9.11.1</code>环境下测试，慢于 <code>setTimeout(fn, 0)</code>)</li> <li><code>requestAnamationFrame</code>（浏览器）</li></ul> <p><strong>microtask</strong>（由 javascript 引擎发起）</p> <ul><li><code>Promise</code>的<code>then</code>、<code>catch</code>、<code>finally</code></li> <li><code>process.nextTick</code>（<code>node</code>）</li> <li><code>MutationObserver</code>（浏览器）</li></ul> <h3 id="process-nexttick"><a href="#process-nexttick" class="header-anchor">#</a> <code>process.nextTick</code></h3> <p>应用例子：用于事件监听，防止触发一个操作时，事件还没绑定。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> server <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;listening&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="ajax"><a href="#ajax" class="header-anchor">#</a> <code>ajax</code></h2> <h4 id="原生写法"><a href="#原生写法" class="header-anchor">#</a> 原生写法</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>XMLHttpRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>　 <span class="token comment">// Mozilla, Safari...</span>
  xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>ActiveXObject<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// IE</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActiveXObject</span><span class="token punctuation">(</span><span class="token string">'Msxml2.XMLHTTP'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActiveXObject</span><span class="token punctuation">(</span><span class="token string">'Microsoft.XMLHTTP'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  xhr<span class="token punctuation">.</span>onreadystatechange <span class="token operator">=</span> onReadyStateChange<span class="token punctuation">;</span>
  xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span> <span class="token string">'http://localhost:3000/user'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 设置 Content-Type 为 application/x-www-form-urlencoded</span>
  <span class="token comment">// 以表单的形式传递数据</span>
  xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'application/x-www-form-urlencoded'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'username=admin&amp;password=root'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// onreadystatechange 方法</span>
<span class="token keyword">function</span> <span class="token function">onReadyStateChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 该函数会被调用四次</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState <span class="token operator">===</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// everything is good, the response is received</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'There was a problem with the request.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// still not ready</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'still not ready...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="fetch"><a href="#fetch" class="header-anchor">#</a> <code>fetch</code></h4> <p>基于 Promise 设计，基础用法如下。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  method<span class="token operator">:</span> <span class="token string">'post'</span><span class="token punctuation">,</span>
  body<span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    a<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    b<span class="token operator">:</span> <span class="token number">2</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token comment">// body: 'a=1&amp;b=2',</span>
  headers<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'application/json'</span>
    <span class="token comment">// 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 是否带cookie</span>
  <span class="token comment">// same-origin: 同源带 include: 始终带 omit: 不带</span>
  credentials<span class="token operator">:</span> <span class="token string">'omit'</span> <span class="token comment">//默认</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
    <span class="token parameter">response</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 在这里进行中间件操作，封装</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>ok<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// throw new Error('fetch done. but something is wrong!')</span>
        <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          status<span class="token operator">:</span> response<span class="token punctuation">.</span>status<span class="token punctuation">,</span>
          statusText<span class="token operator">:</span> response<span class="token punctuation">.</span>statusText
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 请求本身没成功，比如url地址错误</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fetch is error'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 处理最终结果</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 中间件捕获的错误</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p> 有几个坑</p> <ul><li><code>cookie</code> 传递</li> <li><code>404</code>、<code>503</code> 等错误不被认为是网络错误，是不会抛错的。在中间件里用 <code>reponse.ok</code> 与 <code>response.status</code> 来确定处理</li></ul> <h3 id="连等赋值"><a href="#连等赋值" class="header-anchor">#</a> 连等赋值</h3> <p>一道”面试“题</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">{</span> n<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
a<span class="token punctuation">.</span>x <span class="token operator">=</span> a <span class="token operator">=</span> <span class="token punctuation">{</span> n<span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ???</span>
</code></pre></div><ul><li>连等赋值会提前保存对象的引用，复制时右边取新的，左边取提前保存的。</li> <li>A=B=C 的调用过程其实是 B=C，再执行 A=B，注意 C 值只调用一次（可用 getter 进行测试）</li></ul> <p>所以上述答案为<code>undefined</code></p> <h2 id="array"><a href="#array" class="header-anchor">#</a> Array</h2> <h3 id="array-prototype-map"><a href="#array-prototype-map" class="header-anchor">#</a> Array.prototype.map</h3> <p>内部原理：</p> <ul><li>提前预知并确定循环长度</li> <li>执行时
<ul><li>元素为 empty，不进行方法调用，并在返回值中设为 empty</li> <li>元素不为 empty，获取此刻原数组的元素值，执行方法调用</li></ul></li></ul> <blockquote><p>使用 map 方法处理数组时，数组元素的范围是在 callback 方法第一次调用之前就已经确定了。在 map 方法执行的过程中：原数组中新增加的元素将不会被 callback 访问到；若已经存在的元素被改变或删除了，则它们的传递到 callback 的值是 map 方法遍历到它们的那一时刻的值；而被删除的元素将不会被访问到。 —— MDN https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Array/map</p></blockquote> <blockquote><p>边循环边更改原数组时，有两个特点。一是循环长度只减不增，二是循环值为更改后原数组按 index 取值。</p></blockquote> <h3 id="array-prototype-reduce"><a href="#array-prototype-reduce" class="header-anchor">#</a> Array.prototype.reduce</h3> <p>传入函数的 a，b 值并不是数组的每一项，准确的讲，分别为累加器与当前项，有 2 种情况：</p> <ul><li>设定了初始值，第 1 次循环，累加器值为初始值</li> <li>未设定初始值，第 1 次循环，累加器值为第 1 项，且从数组第 2 项开始循环</li></ul> <p>综上，应避免以下错误：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// ❌ 报错</span>
<span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//一定要确定数组不为空</span>
arr<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> a <span class="token operator">+</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ❌ 结果为NaN</span>
<span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> price<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> price<span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
arr<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> a<span class="token punctuation">.</span>price <span class="token operator">+</span> b<span class="token punctuation">.</span>price<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="empty"><a href="#empty" class="header-anchor">#</a> empty</h3> <p>使用<code>delete arr[i]</code>，原数组的下标并不会改变，而是在原来的下边出，把值设为 empty，此值有一定的特殊性。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
arr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
<span class="token keyword">delete</span> arr<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;changed : &quot;</span><span class="token punctuation">,</span> arr<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// for (不跳过任意)</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">for </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// map（跳过empty，返回结果包含empty）</span>
<span class="token keyword">const</span> mapedArr <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">map </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>v<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">mapedArr </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>mapedArr<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> mapedArr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// filter（跳过empty，返回结果不包含empty）</span>
arr<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">forEach </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>v<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> filteredArr <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">filter </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>v<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">filteredArr </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filteredArr<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> filteredArr<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="async-await-2"><a href="#async-await-2" class="header-anchor">#</a> async/await</h3> <p>注意 for 循环（循环之间会等待）与 forEach（不会等待）调用的不同。</p> <h3 id="稀疏与密集数组"><a href="#稀疏与密集数组" class="header-anchor">#</a> 稀疏与密集数组</h3> <p>稀疏数组即非连续性数组，里面有空元素，这在使用数组方法（map,forEach 等）时不会遍历该元素。</p> <p>快速创建密集数组：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//</span>
<span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token function">Array</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token function">Array</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// [undefined, undefined, undefined]</span>

<span class="token comment">// 扩展应用</span>
<span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token function">Array</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token function">Array</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

arr<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>Number<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
arr<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>call<span class="token punctuation">,</span> Number<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 等同于下面</span>
arr<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">v<span class="token punctuation">,</span> i<span class="token punctuation">,</span> array</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">Number</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> i<span class="token punctuation">,</span> array<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// [1, 2, 3, 4, 5]</span>
<span class="token comment">// ？？？为什么这样不行，arr.map(Number.call)</span>
</code></pre></div><h2 id="数据转换为规则"><a href="#数据转换为规则" class="header-anchor">#</a> 数据转换为规则</h2> <h3 id="toprimitive"><a href="#toprimitive" class="header-anchor">#</a> ToPrimitive</h3> <h4 id="string-2"><a href="#string-2" class="header-anchor">#</a> string</h4> <p>调用 toString 方法：</p> <ul><li>原始值，强转 string 后的原始值</li> <li>非原始值，调用 valueOf 方法
<ul><li>原始值，强转 string 后的原始值</li> <li>非原始值，抛出异常<code>TypeError: Cannot convert object to primitive value</code></li></ul></li></ul> <h4 id="number-2"><a href="#number-2" class="header-anchor">#</a> number</h4> <p>调用 valueOf 方法：</p> <ul><li>原始值，return 强转 number 后的原始值</li> <li>非原始值，调用 toString 方法 - 原始值，return 强转 number 后的原始值 - 非原始值，抛出异常<code>TypeError: Cannot convert object to primitive value</code> <blockquote><p>强转 number 规则，null -&gt; 0，undefined -&gt; NaN，true -&gt; 1，false -&gt; 0，失败 -&gt; NaN</p></blockquote></li></ul> <h2 id="递归"><a href="#递归" class="header-anchor">#</a> 递归</h2> <p>纯粹的函数式编程语言没有循环操作命令，所有的循环都用递归实现。</p> <p>递归就是函数自己调用自己。</p> <h3 id="尾调用"><a href="#尾调用" class="header-anchor">#</a> 尾调用</h3> <p>函数最后一步调用一个函数，只调用函数，不做其它运算。</p> <h3 id="尾递归"><a href="#尾递归" class="header-anchor">#</a> 尾递归</h3> <p>函数最后一步调用自身。</p> <p>例如：一个阶乘函数，n 够大时发生栈溢出。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">factorial</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> n <span class="token operator">*</span> <span class="token function">factorial</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>改写成尾递归，由于每次执行完后不需要保持当前作用域的变量，所以可销毁，永远只有一层（V8 引擎未实现）。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">factorial</span><span class="token punctuation">(</span><span class="token parameter">n<span class="token punctuation">,</span> total</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> total<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">factorial</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> n <span class="token operator">*</span> total<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>对于不支持自动优化的，改写为迭代模式。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">factorial</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> initialValue <span class="token operator">=</span> v<span class="token punctuation">;</span>
  <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>initialValue <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    result <span class="token operator">=</span> initialValue <span class="token operator">*</span> result<span class="token punctuation">;</span>
    initialValue<span class="token operator">--</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="内存管理"><a href="#内存管理" class="header-anchor">#</a> 内存管理</h2> <h3 id="gc（garbage-collection）"><a href="#gc（garbage-collection）" class="header-anchor">#</a> GC（Garbage Collection）</h3> <ul><li>引用计数（reference counting）。缺点：无法解决循环引用。</li> <li>标记清除（mark and sweep algorithm）</li></ul> <h3 id="常见内存泄漏"><a href="#常见内存泄漏" class="header-anchor">#</a> 常见内存泄漏</h3> <ul><li>全局变量。不声明变量或者全局作用域函数中调用 this，不小心把变量挂载到全局对象上，此变量一直被全局对象引用，只有关闭窗口或者重新刷新页面才被释放。</li> <li>console.log。传入的对象会被一直引用，不会被 GC 回收。</li> <li>闭包。首先闭包本身带作用域，所以占用内存会比一般的多。然后在使用时，很多不明显的变量会被缓存，例如:</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> str <span class="token operator">=</span> <span class="token function">Array</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;#&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> foo <span class="token operator">=</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">&quot;foo&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token function-variable function">unused</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> message <span class="token operator">=</span> <span class="token string">&quot;it is only a test message&quot;</span><span class="token punctuation">;</span>
    str <span class="token operator">=</span> <span class="token string">&quot;unused: &quot;</span> <span class="token operator">+</span> str<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;data&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> getData<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#btn&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
  <span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token boolean">false</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// str变量虽然没使用，但一直被缓存。</span>
</code></pre></div><p>解释如下：在相同作用域内创建的多个内部函数对象是共享同一个变量对象 AO。如果创建的内部函数没有被其他对象引用，不管内部函数是否引用外部函数的变量和函数，在外部函数执行完，对应变量对象便会被销毁。反之，如果内部函数中存在有对外部函数变量或函数的访问（可以不是被引用的内部函数），并且存在某个或多个内部函数被其他对象引用，那么就会形成闭包，外部函数的变量对象就会存在于闭包函数的作用域链中。这样确保了闭包函数有权访问外部函数的所有变量和函数。</p> <p>个人理解：内部函数没有被引用，那么所有变量执行完后就销毁。如果有一个内部函数被其他地方引用，那么大家（所有内部函数）引用的东西都得存在闭包里面，就算你没有被其他地方引用也得存下来。</p> <p>另一个闭包泄露例子：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> theThing <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> <span class="token function-variable function">replaceThing</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> originalThing <span class="token operator">=</span> theThing<span class="token punctuation">;</span>
  <span class="token keyword">var</span> <span class="token function-variable function">unused</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>originalThing<span class="token punctuation">)</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;hi&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  theThing <span class="token operator">=</span> <span class="token punctuation">{</span>
    longStr<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function-variable function">someMethod</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>someMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">setInterval</span><span class="token punctuation">(</span>replaceThing<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>DOM。dom 赋值给变量，dom 销毁后，变量依然保持引用，造成 dom 没有被真正销毁。</li> <li>timers。一般是 setInterval 用完没有被及时 clear 以及 setTimeout 嵌套没有被正确终止。</li> <li>EventListener。一般是某个重复事件中绑定其他 dom 事件，当事件重复执行时，造成了重复绑定，导致异常。
<blockquote><p>dom.addEventListener('click', fn, false)这种方式多次执行绑定不会增加新事件。</p></blockquote></li></ul> <h2 id="严格模式"><a href="#严格模式" class="header-anchor">#</a> 严格模式</h2> <p>包括但不限于以下特点：</p> <ul><li>全局对象为 undefined。这样就不会因为未声明变量而挂载到全局对象上，从而造成内存泄漏，因为一旦挂载了，那么只有刷新页面或者关闭 tab 才会被释放。</li> <li>arguments 不可用。据阮一峰文章解释，这样就可以优化尾递归，因为非严格模式拥有 arguments.callee，需指向本身，造成了作用域栈不能被优化。（测试未通过）</li></ul> <h2 id="json-stringify"><a href="#json-stringify" class="header-anchor">#</a> JSON.stringify</h2> <h3 id="第-2-个参数"><a href="#第-2-个参数" class="header-anchor">#</a> 第 2 个参数</h3> <p>只针对对象有作用</p> <h4 id="数组"><a href="#数组" class="header-anchor">#</a> 数组</h4> <p>只转换数组内的 key 值，无则转换为<code>{}</code>。</p> <h4 id="函数"><a href="#函数" class="header-anchor">#</a> 函数</h4> <p>针对每一次的返回进行处理。比如可以转换<code>{ a: new Set([1]) }</code></p> <h3 id="第-3-个参数"><a href="#第-3-个参数" class="header-anchor">#</a> 第 3 个参数</h3> <p>只针对对象有作用，用于美化对象的输出。</p> <h4 id="数字"><a href="#数字" class="header-anchor">#</a> 数字</h4> <p>0 就是默认，比 0 小无效。每一行前面加相应数目的空格。</p> <h4 id="字符串"><a href="#字符串" class="header-anchor">#</a> 字符串</h4> <p>每一行前面加相应的字符。</p> <h2 id="模块化"><a href="#模块化" class="header-anchor">#</a> 模块化</h2> <h3 id="amd（require-js）"><a href="#amd（require-js）" class="header-anchor">#</a> AMD（require.js）</h3> <p>依赖提前下载，然后乱序执行，等待所有模块执行完毕，执行回调函数，输出值的一份引用</p> <h3 id="cmd-common-module-definition-（sea-js）"><a href="#cmd-common-module-definition-（sea-js）" class="header-anchor">#</a> CMD (Common Module Definition)（sea.js）</h3> <p>依赖提前下载，然后运行到使用 require 关键词的地方再执行，输出值的一份引用</p> <h3 id="commonjs"><a href="#commonjs" class="header-anchor">#</a> commonjs</h3> <p>一个文件即一个模块即一个模块对象，使用<code>module.exports = 值</code>或者<code>exports = 值</code>导出。打包后，输出到 module 中的 exports 对象里</p> <p>node 中的模块缓存对象：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token punctuation">{</span>
  <span class="token string">'模块的绝对路径'</span><span class="token operator">:</span> Module <span class="token punctuation">{</span>
    id<span class="token operator">:</span> <span class="token string">'.'</span><span class="token punctuation">,</span>
    path<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    exports<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    parent<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    filename<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    loaded<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    children<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">[</span>Module<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>Module<span class="token punctuation">]</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
    paths<span class="token operator">:</span> <span class="token string">'查找搜索路径'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="esmodule"><a href="#esmodule" class="header-anchor">#</a> esModule</h3> <p>使用<code>export default 值</code>或者<code>export 定义式</code>导出，后者使用定义式是因为打包工具需要把变量命挂在到 module.exports 的 getter 上（这样能获取到实时的值），而把前者放到 module.exports.default 里。</p> <h3 id="区别"><a href="#区别" class="header-anchor">#</a> 区别</h3> <p>commonjs 是运行时再加载，而 esModule 在初期就已经分析出依赖关系，预留好了要 export 的对象的内存，在具体执行时再进行填值。但是打包工具是把 esModule 打包成 commonjs 的模块。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/css/">
        CSS 基础
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.ed89f765.js" defer></script><script src="/assets/js/2.ee146c9e.js" defer></script><script src="/assets/js/4.46766430.js" defer></script>
  </body>
</html>
